{% extends "base.html" %}
{% block content %}

<div class="hmv-page">

  <!-- Header interno -->
  <div class="hmv-topbar">
    <div>
      <h1 class="hmv-title">‚ûï Nueva Cirug√≠a</h1>
      <p class="hmv-subtitle">Captura programaci√≥n, paciente, procedimiento y evidencia</p>
    </div>

    <div class="hmv-actions">
      <a href="{{ url_for('cirugias') }}" class="btn btn-hmv-outline">‚Üê Volver</a>
    </div>
  </div>

  <div class="hmv-card">
    <form method="post" enctype="multipart/form-data" class="row g-3" id="form_nueva_cirugia">

      <!-- Programaci√≥n -->
      <div class="hmv-section" style="margin-top:0;">
        <div class="hmv-section-title">Programaci√≥n</div>

        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Fecha *</label>
            <input type="date" name="fecha" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Hora inicio *</label>
            <input type="time" name="hora_inicio" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Duraci√≥n (min) *</label>
            <input
              type="number"
              name="duracion_min"
              class="form-control"
              min="10"
              max="1440"
              value="60"
              required
            >
            <div class="form-text">Obligatoria. Estimaci√≥n inicial (10‚Äì1440 min).</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Quir√≥fano *</label>
            <input type="text" name="quirofano" class="form-control" placeholder="QX 1" required>
          </div>
        </div>
      </div>

      <!-- Paciente -->
      <div class="hmv-section">
        <div class="hmv-section-title">Paciente</div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Paciente *</label>
            <input type="text" name="paciente" class="form-control" required>
          </div>

          <div class="col-md-2">
            <label class="form-label">Edad *</label>
            <input type="number" name="edad" class="form-control" min="0" max="120" required>
          </div>

          <div class="col-md-2">
            <label class="form-label">Sexo *</label>
            <select name="sexo" class="form-select" required>
              <option value="" selected disabled>Selecciona</option>
              {% for s in sexos %}
                <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Tel√©fono</label>
            <input type="text" name="telefono" class="form-control" placeholder="(opcional)">
            <div class="form-text">Opcional por ahora.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Folio / Expediente *</label>
            <input type="text" name="folio_expediente" class="form-control" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Especialidad</label>
            <input type="text" name="especialidad" class="form-control" placeholder="Gine, Trauma...">
            <div class="form-text">Opcional (luego afinamos cat√°logo).</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Program√≥ *</label>
            <input type="text" name="programo" class="form-control" placeholder="Nombre / iniciales" required>
          </div>
        </div>
      </div>

      <!-- Procedimiento y equipo -->
      <div class="hmv-section">
        <div class="hmv-section-title">Procedimiento y equipo</div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Procedimiento *</label>
            <input type="text" name="procedimiento" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Cirujano *</label>
            <input type="text" name="cirujano" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Anestesi√≥logo *</label>
            <input type="text" name="anestesiologo" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Ayudantes *</label>
            <input type="text" name="ayudantes" class="form-control" placeholder="Ej: Dr. X, Dr. Y" required>
            <div class="form-text">Ponlos separados por coma.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Instrumentista *</label>
            <input type="text" name="instrumentista" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Estado</label>
            <select name="estado" class="form-select">
              {% for e in estados %}
                <option value="{{ e }}" {% if e == "PROGRAMADA" %}selected{% endif %}>{{ e }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Indicaciones / Evidencia -->
      <div class="hmv-section">
        <div class="hmv-section-title">Indicaciones y evidencia</div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Indicaciones especiales</label>
            <textarea name="indicaciones_especiales" class="form-control" rows="3" placeholder="Ayuno, antibi√≥tico, material especial, etc."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Foto de la orden f√≠sica *</label>

            <!-- UN SOLO INPUT real (m√°s estable en m√≥vil) -->
            <input
              type="file"
              name="orden_foto"
              id="orden_foto"
              accept="image/*"
              hidden
              required
            >

            <div class="d-flex gap-2 flex-wrap" style="margin-top:6px;">
              <button type="button" class="btn btn-hmv-outline" id="btn_orden_camara">
                üì∑ C√°mara
              </button>

              <button type="button" class="btn btn-hmv-outline" id="btn_orden_galeria">
                üñºÔ∏è Galer√≠a
              </button>
            </div>

            <div class="form-text" id="orden_foto_nombre" style="margin-top:8px;">
              Obligatoria. Sube una imagen (JPG/PNG/WEBP).
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="d-flex gap-2">
        <button class="btn btn-hmv" type="submit">Guardar</button>
        <a class="btn btn-hmv-outline" href="{{ url_for('cirugias') }}">Cancelar</a>
      </div>

    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("form_nueva_cirugia");
    const input = document.getElementById("orden_foto");
    const info = document.getElementById("orden_foto_nombre");

    const btnCam = document.getElementById("btn_orden_camara");
    const btnGal = document.getElementById("btn_orden_galeria");

    function setNombre(file){
      if (!info) return;
      info.textContent = file
        ? `Seleccionado: ${file.name}`
        : "Obligatoria. Sube una imagen (JPG/PNG/WEBP).";
    }

    btnCam?.addEventListener("click", () => {
      // Forzar c√°mara trasera cuando aplique
      input.setAttribute("capture", "environment");
      input.click();
    });

    btnGal?.addEventListener("click", () => {
      // Galer√≠a (sin capture)
      input.removeAttribute("capture");
      input.click();
    });

    input?.addEventListener("change", () => {
      setNombre(input.files && input.files[0] ? input.files[0] : null);
    });

    // Asegurar archivo antes de enviar (m√≥vil a veces ignora required si hidden)
    form?.addEventListener("submit", (e) => {
      const file = input.files && input.files[0] ? input.files[0] : null;
      if (!file) {
        e.preventDefault();
        setNombre(null);
        alert("La foto de la orden f√≠sica es obligatoria.");
        return;
      }
    });
  });
</script>

{% endblock %}
