{% extends "base.html" %}
{% block title %}Editar producto | HMV{% endblock %}

{% block content %}
<div class="hmv-card" style="margin-top:16px;">
  <div class="hmv-card-header">
    <div>
      <h1 class="hmv-title" style="margin:0;">Editar producto</h1>
      <div class="hmv-muted">
        Actualiza datos, costos y empaque. El sistema recalcula piezas y precio sugerido.
      </div>
    </div>

    <div class="hmv-actions">
      <a href="{{ url_for('productos') }}" class="hmv-btn-outline">Cancelar</a>
      <button type="submit" form="form-editar" class="hmv-btn-primary">Actualizar</button>
    </div>
  </div>

  <div class="hmv-card-body">
    <form id="form-editar" method="post" enctype="multipart/form-data">

      <!-- Datos básicos -->
      <div class="hmv-section">
        <div class="hmv-section-title">Datos básicos</div>

        <div class="hmv-form-grid hmv-cols-2">
          <div class="hmv-field">
            <label>Nombre</label>
            <input type="text" name="nombre" value="{{ producto.nombre }}" required>
          </div>

          <div class="hmv-field">
            <label>Código</label>
            <input type="text" name="codigo" value="{{ producto.codigo }}" required>
          </div>
        </div>

        <div class="hmv-field" style="margin-top:12px;">
          <label>Descripción</label>
          <textarea name="descripcion" rows="2">{{ producto.descripcion or '' }}</textarea>
        </div>

        <div class="hmv-form-grid hmv-cols-3" style="margin-top:12px;">
          <div class="hmv-field">
            <label>Marca / Proveedor</label>
            <input type="text" name="proveedor" value="{{ producto.proveedor or '' }}">
          </div>

          <div class="hmv-field">
            <label>Lote</label>
            <input type="text" name="lote" value="{{ producto.lote or '' }}">
          </div>

          <div class="hmv-field">
            <label>Categoría</label>
            <input type="text" name="categoria" value="{{ producto.categoria or '' }}">
          </div>
        </div>
      </div>

      <!-- Unidades y empaque -->
      <div class="hmv-section">
        <div class="hmv-section-title">Unidades y empaque</div>
        <div class="hmv-muted" style="font-size:12px; margin-bottom:10px;">
          Tip: Si compras por caja y surtas por piezas, captura piezas por unidad para que el sistema convierta a pzas.
        </div>

        <div class="hmv-form-grid hmv-cols-3">
          <div class="hmv-field">
            <label>Unidad de uso / salida</label>
            <input type="text" name="unidad" value="{{ producto.unidad or '' }}" required>
            <div class="hmv-help">Ej. pza, frasco, caja…</div>
          </div>

          <div class="hmv-field">
            <label>Unidad de compra (opcional)</label>
            <input type="text" name="unidad_compra" value="{{ producto.unidad_compra or '' }}" placeholder="caja, paquete, etc.">
            <div class="hmv-help">Cómo lo compras al proveedor.</div>
          </div>

          <div class="hmv-field">
            <label>Piezas por unidad de compra</label>
            <input type="number" name="piezas_por_unidad" id="piezas_por_unidad"
                   min="0" value="{{ producto.piezas_por_unidad or 0 }}" oninput="calcularTodo()">
            <div class="hmv-help">Ej. caja con 50 → 50</div>
          </div>
        </div>

        <div class="hmv-form-grid hmv-cols-2" style="margin-top:12px;">
          <div class="hmv-field">
            <label>Cantidad (lo que estás registrando)</label>
            <input type="number" name="cantidad" id="cantidad" min="0" required
                   value="{{ producto.cantidad or 0 }}" oninput="calcularTodo()">
            <div class="hmv-help">
              Si pusiste piezas por unidad, aquí son <b>unidades de compra</b> (ej. cajas). Si no, se toma como <b>piezas</b>.
            </div>
          </div>

          <div class="hmv-field">
            <label>Stock mínimo</label>
            <input type="number" name="stock_minimo" min="0" value="{{ producto.stock_minimo or 0 }}" required>
            <div class="hmv-help">Se marcará “BAJO” cuando el stock sea igual o menor a este número.</div>
          </div>
        </div>

        <div class="hmv-callout" style="margin-top:12px;">
          <div class="hmv-row">
            <div style="font-weight:900;">Equivalencia aproximada</div>
            <div class="hmv-muted" style="font-size:12px;">solo visual</div>
          </div>

          <div style="margin-top:10px;">
            <span class="badge-hmv">Total piezas estimadas</span>
            <span style="font-weight:900; margin-left:8px;" id="preview_piezas">0</span>
            {% if producto.cantidad_piezas is not none %}
              <span class="hmv-muted" style="margin-left:8px;">(en BD: {{ producto.cantidad_piezas }} pzas)</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Costos y precios -->
      <div class="hmv-section">
        <div class="hmv-section-title">Costos y precios</div>
        <div class="hmv-muted" style="font-size:12px; margin-bottom:10px;">
          Precio sugerido = costo + 35% (y si activas IVA, se agrega 16%).
        </div>

        <div class="hmv-form-grid hmv-cols-3">
          <div class="hmv-field">
            <label>Costo</label>
            <input type="number" name="costo" id="costo" step="0.01" min="0"
                   value="{{ producto.costo if producto.costo is not none else '' }}" oninput="calcularTodo()">
          </div>

          <div class="hmv-field">
            <label>IVA</label>
            <div class="hmv-checkbox">
              <input type="checkbox" name="aplica_iva" id="aplica_iva" onchange="calcularTodo()"
                     {% if producto.aplica_iva %}checked{% endif %}>
              <div>
                <div style="font-weight:900;">Aplicar IVA (16%)</div>
                <div class="hmv-muted" style="font-size:12px;">Si el precio final debe incluir IVA.</div>
              </div>
            </div>
          </div>

          <div class="hmv-field">
            <label>Precio sugerido / final</label>
            <input type="number" name="precio" id="precio" step="0.01" min="0"
                   value="{{ producto.precio if producto.precio is not none else '' }}">
            <div class="hmv-help">Se llena automático, pero lo puedes ajustar.</div>
          </div>
        </div>

        <div class="hmv-callout" style="margin-top:12px;">
          <div class="hmv-row">
            <div style="font-weight:900;">Resumen</div>
            <div class="hmv-muted" style="font-size:12px;">cálculo en vivo</div>
          </div>

          <div style="margin-top:10px; font-size:13px;">
            <div>Margen: <b>35%</b></div>
            <div>IVA: <b id="preview_iva">No</b></div>

            <div style="margin-top:10px;">
              <span class="badge-hmv hmv-badge-success">Precio sugerido</span>
              <span style="font-weight:900; margin-left:8px;" id="preview_precio">$0.00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fechas e imagen -->
      <div class="hmv-section">
        <div class="hmv-section-title">Fechas e imagen</div>

        <div class="hmv-form-grid hmv-cols-2">
          <div class="hmv-field">
            <label>Fecha de ingreso</label>
            <input type="date" name="fecha_ingreso"
                   value="{{ producto.fecha_ingreso.strftime('%Y-%m-%d') if producto.fecha_ingreso else '' }}">
          </div>

          <div class="hmv-field">
            <label>Fecha de caducidad</label>
            <input type="date" name="fecha_caducidad"
                   value="{{ producto.caducidad.strftime('%Y-%m-%d') if producto.caducidad else '' }}">
          </div>
        </div>

        <div class="hmv-divider"></div>

        <div class="hmv-field">
          <label>Imagen</label>
          <input type="file" name="imagen">
          {% if producto.imagen %}
            <div class="hmv-help">Imagen actual: <b>{{ producto.imagen }}</b></div>
            <div style="margin-top:10px;">
              <img src="{{ url_for('static', filename='uploads/' + producto.imagen) }}"
                   alt="Imagen del producto" class="hmv-thumb" style="width:180px;height:auto;">
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Acciones abajo -->
      <div class="hmv-actions" style="margin-top:12px;">
        <button type="submit" class="hmv-btn-primary">Actualizar</button>
        <a href="{{ url_for('productos') }}" class="hmv-btn-outline">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
  let precioManual = false;

  function calcularPrecio() {
    const costoEl = document.getElementById("costo");
    const precioEl = document.getElementById("precio");
    const aplicaIvaEl = document.getElementById("aplica_iva");

    const previewPrecio = document.getElementById("preview_precio");
    const previewIva = document.getElementById("preview_iva");

    const costoRaw = (costoEl.value || "").trim();
    const costo = parseFloat(costoRaw);
    const aplicaIva = aplicaIvaEl.checked;

    previewIva.textContent = aplicaIva ? "Sí" : "No";

    // Si costo vacío: limpia preview y no fuerzas precio
    if (costoRaw === "" || isNaN(costo)) {
      previewPrecio.textContent = "$0.00";
      if (!precioManual) precioEl.value = "";
    } else {
      let sugerido = costo * 1.35;
      if (aplicaIva) sugerido = sugerido * 1.16;

      if (!precioManual || precioEl.value.trim() === "") {
        precioEl.value = sugerido.toFixed(2);
        precioManual = false;
      }

      previewPrecio.textContent = "$" + sugerido.toFixed(2);
    }
  }

  function calcularPiezas() {
    const cant = parseInt((document.getElementById("cantidad").value || "0"), 10);
    const ppu = parseInt((document.getElementById("piezas_por_unidad").value || "0"), 10);

    let piezas = 0;
    if (!isNaN(cant)) {
      piezas = (!isNaN(ppu) && ppu > 0) ? cant * ppu : cant;
    }
    document.getElementById("preview_piezas").textContent = String(piezas);
  }

  function calcularTodo(){
    calcularPrecio();
    calcularPiezas();
  }

  window.addEventListener("DOMContentLoaded", () => {
    calcularTodo();

    const precioEl = document.getElementById("precio");
    precioEl.addEventListener("input", () => {
      precioManual = precioEl.value.trim() !== "";
    });
  });
</script>
{% endblock %}
