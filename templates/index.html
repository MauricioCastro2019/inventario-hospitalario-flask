{% extends "base.html" %}
{% block title %}Inventario | HMV{% endblock %}

{% block content %}

  <!-- Encabezado + b√∫squeda -->
  <section class="hmv-card">
    <div class="hmv-card-body">

      <div class="hmv-row">
        <div>
          <div class="hmv-title" style="font-size:22px;">Inventario</div>
          <div class="hmv-muted" style="margin-top:4px;">
            Busca por nombre, c√≥digo o categor√≠a.
            {% if request.args.get('q') %}
              <span class="badge-hmv" style="margin-left:8px;">
                filtro: ‚Äú{{ request.args.get('q') }}‚Äù
              </span>
            {% endif %}
          </div>
        </div>

        <div class="hmv-actions">
          <a class="hmv-btn-primary" href="{{ url_for('agregar') }}">‚ûï Agregar producto</a>
        </div>
      </div>

      <form method="get" style="margin-top:14px;">
        <div class="hmv-row" style="justify-content:flex-start;">
          <input
            type="text"
            name="q"
            style="min-width:260px; flex: 1 1 420px;"
            placeholder="Buscar por nombre, c√≥digo o categor√≠a..."
            value="{{ request.args.get('q', '') }}"
            autocomplete="off"
          >
          <button type="submit" class="hmv-btn-outline">Buscar</button>
          {% if request.args.get('q') %}
            <a class="hmv-btn-outline" href="{{ url_for('productos') }}">Limpiar</a>
          {% endif %}
        </div>
      </form>

    </div>
  </section>

  <!-- Tabla -->
  <section class="hmv-card" style="margin-top:12px;">
    <div class="hmv-card-body">
      <div class="hmv-table-wrap">
        <table class="table-hmv" style="width:100%;">
          <thead>
            <tr>
              <th style="white-space:nowrap;">Imagen</th>
              <th style="white-space:nowrap;">Nombre</th>
              <th style="white-space:nowrap;">C√≥digo</th>
              <th style="white-space:nowrap;">Categor√≠a</th>
              <th style="white-space:nowrap;">Unidad</th>
              <th style="white-space:nowrap;">Stock</th>
              <th style="white-space:nowrap;">Costo</th>
              <th style="white-space:nowrap;">Precio</th>
              <th style="white-space:nowrap;">Ingreso</th>
              <th style="white-space:nowrap;">Caducidad</th>
              <th style="white-space:nowrap;">Marca/Proveedor</th>
              <th style="white-space:nowrap;">Lote</th>
              <th style="white-space:nowrap;">√öltima mod.</th>
              <th style="white-space:nowrap;">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for producto in productos %}
              {% set stock_pzas = (producto.cantidad_piezas if producto.cantidad_piezas is not none else (producto.cantidad or 0)) %}
              {% set minimo = (producto.stock_minimo if producto.stock_minimo is not none else 0) %}
              {% set bajo = (stock_pzas <= minimo) %}

              <tr>
                <td style="width:90px;">
                  {% if producto.imagen %}
                    <img
                      src="{{ url_for('static', filename='uploads/' + producto.imagen) }}"
                      alt="img"
                      class="hmv-thumb"
                      loading="lazy"
                    >
                  {% else %}
                    <span class="hmv-muted" style="font-size:12px;">Sin imagen</span>
                  {% endif %}
                </td>

                <td style="font-weight:900;">
                  {{ producto.nombre }}
                  {% if bajo %}
                    <span class="badge-hmv hmv-badge-danger" style="margin-left:8px;">BAJO</span>
                  {% endif %}
                </td>

                <td>{{ producto.codigo }}</td>
                <td>{{ producto.categoria or '' }}</td>
                <td>{{ producto.unidad or '' }}</td>

                <td class="{% if bajo %}hmv-stock-low{% endif %}">
                  <div>
                    <div>
                      {{ stock_pzas }} <span class="hmv-muted" style="font-size:12px;">pzas</span>
                    </div>

                    {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
                      <div class="hmv-muted" style="font-size:12px;margin-top:4px;">
                        ‚âà {{ (stock_pzas // producto.piezas_por_unidad) }}
                        {{ producto.unidad_compra or 'unid' }}
                        ({{ producto.piezas_por_unidad }} pzas c/u)
                      </div>
                    {% endif %}

                    {% if minimo %}
                      <div class="hmv-muted" style="font-size:12px;margin-top:2px;">
                        m√≠n: {{ minimo }} pzas
                      </div>
                    {% endif %}
                  </div>
                </td>

                <td>
                  {% if producto.costo is not none %}
                    ${{ '%.2f'|format(producto.costo) }}
                  {% else %}
                    <span class="hmv-muted">‚Äî</span>
                  {% endif %}
                </td>

                <td>
                  {% if producto.precio is not none %}
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                      <span>${{ '%.2f'|format(producto.precio) }}</span>
                      {% if producto.aplica_iva %}
                        <span class="badge-hmv hmv-badge-success">IVA</span>
                      {% endif %}
                    </div>

                    <div class="hmv-muted" style="font-size:12px;margin-top:4px;">
                      margen: {{ ((producto.margen if producto.margen is not none else 0.35) * 100) | round(0) }}%
                    </div>
                  {% else %}
                    <span class="hmv-muted">‚Äî</span>
                  {% endif %}
                </td>

                <td>{{ producto.fecha_ingreso.strftime('%Y-%m-%d') if producto.fecha_ingreso else '' }}</td>
                <td>{{ producto.caducidad.strftime('%Y-%m-%d') if producto.caducidad else '' }}</td>
                <td>{{ producto.proveedor or '' }}</td>
                <td>{{ producto.lote or '' }}</td>
                <td>{{ producto.ultima_modificacion.strftime('%Y-%m-%d %H:%M') if producto.ultima_modificacion else '' }}</td>

                <td style="white-space:nowrap;">
                  <a href="{{ url_for('editar', id=producto.id) }}" class="hmv-btn-sm">‚úèÔ∏è Editar</a>
                  <a href="{{ url_for('movimientos', producto_id=producto.id) }}" class="hmv-btn-sm">üìã Movimientos</a>
                </td>
              </tr>
            {% endfor %}

            {% if productos|length == 0 %}
              <tr>
                <td colspan="14" style="text-align:center;" class="hmv-muted">
                  No hay productos a√∫n.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

{% endblock %}
