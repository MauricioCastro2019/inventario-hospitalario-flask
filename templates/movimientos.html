{% extends "base.html" %}
{% block title %}Movimientos | HMV{% endblock %}

{% block content %}

  {% if producto %}
    {% set stock_pzas = (producto.cantidad_piezas if producto.cantidad_piezas is not none else (producto.cantidad or 0)) %}

    <!-- HEADER -->
    <section class="hmv-card" style="margin-top:16px;">
      <div class="hmv-card-header">
        <div>
          <div class="hmv-title" style="font-size:22px;">Movimientos</div>
          <div class="hmv-muted" style="margin-top:4px;">Bit√°cora de entradas y salidas (en piezas).</div>
        </div>

        <div class="hmv-actions">
          <a class="hmv-btn-outline" href="{{ url_for('productos') }}">‚Üê Volver a Productos</a>
          <a class="hmv-btn-primary" href="{{ url_for('nuevo_movimiento', producto_id=producto.id) }}">+ Nuevo movimiento</a>
        </div>
      </div>

      <div class="hmv-card-body">

        <!-- FICHA PRODUCTO -->
        <div class="hmv-callout" style="margin-bottom:12px;">
          <div class="hmv-row" style="align-items:flex-start;">
            <div style="min-width:260px; flex: 1 1 520px;">
              <div style="font-weight:900; font-size:16px;">{{ producto.nombre }}</div>
              <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                <span style="margin-right:14px;"><b>C√≥digo:</b> {{ producto.codigo }}</span>
                <span style="margin-right:14px;"><b>Categor√≠a:</b> {{ producto.categoria or '-' }}</span>
                <span><b>Unidad:</b> {{ producto.unidad or '-' }}</span>
              </div>
            </div>

            <div style="text-align:right; flex: 0 0 auto;">
              <div>
                <span class="hmv-muted">Stock actual:</span>
                <span style="font-weight:900; margin-left:6px;">{{ stock_pzas }}</span>
                <span class="hmv-muted" style="font-size:12px;">pzas</span>
              </div>

              {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
                <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                  ‚âà {{ (stock_pzas // producto.piezas_por_unidad) }}
                  {{ producto.unidad_compra or 'unid' }}
                  ({{ producto.piezas_por_unidad }} pzas c/u)
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- TABLA -->
        <div class="hmv-table-wrap">
          <table class="table-hmv" style="width:100%;">
            <thead>
              <tr>
                <th style="white-space:nowrap;">Fecha</th>
                <th>Producto</th>
                <th style="white-space:nowrap;">Tipo</th>
                <th style="white-space:nowrap;">Cantidad</th>
                <th>Nota</th>
              </tr>
            </thead>

            <tbody>
              {% if movimientos and movimientos|length > 0 %}
                {% for m in movimientos %}
                  <tr>
                    <td style="white-space:nowrap;">
                      {{ m.fecha.strftime('%Y-%m-%d %H:%M') }}
                    </td>

                    <td>
                      {% if m.producto %}
                        <div style="font-weight:900;">{{ m.producto.nombre }}</div>
                        <div class="hmv-muted" style="font-size:12px;">{{ m.producto.codigo }}</div>
                      {% else %}
                        <span class="hmv-muted">‚Äî</span>
                      {% endif %}
                    </td>

                    <td style="white-space:nowrap;">
                      {% if m.tipo == 'entrada' %}
                        <span class="badge-hmv hmv-badge-success">Entrada</span>
                      {% elif m.tipo == 'salida' %}
                        <span class="badge-hmv hmv-badge-danger">Salida</span>
                      {% else %}
                        <span class="badge-hmv">{{ m.tipo }}</span>
                      {% endif %}
                    </td>

                    <td style="white-space:nowrap;">
                      <span style="font-weight:900;">{{ m.cantidad }}</span>
                      <span class="hmv-muted" style="font-size:12px;">pzas</span>

                      {% if m.producto and m.producto.piezas_por_unidad and m.producto.piezas_por_unidad > 0 %}
                        <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                          ‚âà {{ (m.cantidad // m.producto.piezas_por_unidad) }}
                          {{ m.producto.unidad_compra or 'unid' }}
                        </div>
                      {% endif %}
                    </td>

                    <td>{{ m.nota or '' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" style="text-align:center;" class="hmv-muted">
                    A√∫n no hay movimientos registrados para este producto.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </section>

  {% else %}

    <!-- VISTA GENERAL -->
    <section class="hmv-card" style="margin-top:16px;">
      <div class="hmv-card-header">
        <div>
          <div class="hmv-title" style="font-size:22px;">Movimientos</div>
          <div class="hmv-muted" style="margin-top:4px;">
            Vista general de los √∫ltimos movimientos. Para filtrar por producto, entra desde <b>Productos</b>.
          </div>
        </div>

        <div class="hmv-actions">
          <a class="hmv-btn-outline" href="{{ url_for('productos') }}">Ir a Productos</a>
        </div>
      </div>

      <div class="hmv-card-body">

        <div class="hmv-callout" style="margin-bottom:12px;">
          <div class="hmv-row" style="align-items:flex-start;">
            <div>
              <div style="font-weight:900;">Bit√°cora general</div>
              <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                Ideal para auditor√≠a r√°pida y trazabilidad.
              </div>
            </div>
            <div class="hmv-muted" style="font-size:12px;">
              Tip: Productos ‚Üí ‚Äúüìã Movimientos‚Äù filtra por producto.
            </div>
          </div>
        </div>

        <div class="hmv-table-wrap">
          <table class="table-hmv" style="width:100%;">
            <thead>
              <tr>
                <th style="white-space:nowrap;">Fecha</th>
                <th>Producto</th>
                <th style="white-space:nowrap;">Tipo</th>
                <th style="white-space:nowrap;">Cantidad</th>
                <th>Nota</th>
              </tr>
            </thead>

            <tbody>
              {% if movimientos and movimientos|length > 0 %}
                {% for m in movimientos %}
                  <tr>
                    <td style="white-space:nowrap;">
                      {{ m.fecha.strftime('%Y-%m-%d %H:%M') }}
                    </td>

                    <td>
                      {% if m.producto %}
                        <div style="font-weight:900;">{{ m.producto.nombre }}</div>
                        <div class="hmv-muted" style="font-size:12px;">{{ m.producto.codigo }}</div>
                      {% else %}
                        <span class="hmv-muted">‚Äî</span>
                      {% endif %}
                    </td>

                    <td style="white-space:nowrap;">
                      {% if m.tipo == 'entrada' %}
                        <span class="badge-hmv hmv-badge-success">Entrada</span>
                      {% elif m.tipo == 'salida' %}
                        <span class="badge-hmv hmv-badge-danger">Salida</span>
                      {% else %}
                        <span class="badge-hmv">{{ m.tipo }}</span>
                      {% endif %}
                    </td>

                    <td style="white-space:nowrap;">
                      <span style="font-weight:900;">{{ m.cantidad }}</span>
                      <span class="hmv-muted" style="font-size:12px;">pzas</span>

                      {% if m.producto and m.producto.piezas_por_unidad and m.producto.piezas_por_unidad > 0 %}
                        <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                          ‚âà {{ (m.cantidad // m.producto.piezas_por_unidad) }}
                          {{ m.producto.unidad_compra or 'unid' }}
                        </div>
                      {% endif %}
                    </td>

                    <td>{{ m.nota or '' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" style="text-align:center;" class="hmv-muted">
                    A√∫n no hay movimientos registrados.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </section>

  {% endif %}

{% endblock %}
