{% extends "base.html" %}
{% block title %}Nuevo movimiento | HMV{% endblock %}

{% block content %}

  {% set stock_pzas = (producto.cantidad_piezas if producto.cantidad_piezas is not none else (producto.cantidad or 0)) %}
  {% set ppu = (producto.piezas_por_unidad if producto.piezas_por_unidad is not none else 0) %}

  <section class="hmv-card" style="margin-top:16px;">
    <div class="hmv-card-header">
      <div>
        <div class="hmv-title" style="font-size:22px;">Nuevo movimiento</div>
        <div class="hmv-muted" style="margin-top:4px;">
          Registra entradas y salidas en <b>piezas</b> para consistencia y trazabilidad.
        </div>
      </div>

      <div class="hmv-actions">
        <a href="{{ url_for('movimientos', producto_id=producto.id) }}" class="hmv-btn-outline">Cancelar</a>
        <button type="submit" form="form-mov" class="hmv-btn-primary">Guardar movimiento</button>
      </div>
    </div>

    <div class="hmv-card-body">

      <!-- Ficha del producto -->
      <div class="hmv-callout" style="margin-bottom:12px;">
        <div class="hmv-row" style="align-items:flex-start;">
          <div style="min-width:260px; flex: 1 1 520px;">
            <div style="font-weight:900; font-size:16px;">{{ producto.nombre }}</div>
            <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
              <span style="margin-right:14px;"><b>Código:</b> {{ producto.codigo }}</span>
              <span style="margin-right:14px;"><b>Categoría:</b> {{ producto.categoria or '-' }}</span>
              <span><b>Unidad:</b> {{ producto.unidad or '-' }}</span>
            </div>
          </div>

          <div style="text-align:right; flex: 0 0 auto;">
            <div>
              <span class="hmv-muted">Stock actual:</span>
              <span style="font-weight:900; margin-left:6px;" id="stock_actual">{{ stock_pzas }}</span>
              <span class="hmv-muted" style="font-size:12px;">pzas</span>
            </div>

            {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
              <div class="hmv-muted" style="font-size:12px; margin-top:4px;">
                ≈ {{ (stock_pzas // producto.piezas_por_unidad) }}
                {{ producto.unidad_compra or 'unid' }}
                ({{ producto.piezas_por_unidad }} pzas c/u)
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- FORM -->
      <form id="form-mov" method="post">
        <div class="hmv-section" style="margin-bottom:0;">
          <div class="hmv-section-title">Captura del movimiento</div>

          <div class="hmv-row" style="align-items:flex-end; margin-bottom:12px;">
            <div style="flex: 1 1 220px; min-width:220px;">
              <label style="display:block;font-weight:900;font-size:13px;margin-bottom:6px;">Tipo</label>
              <select name="tipo" id="tipo" required onchange="onTipoChange()"
                      style="width:100%; padding:10px 12px; border:1px solid var(--hmv-border); border-radius: var(--hmv-radius-sm);">
                <option value="entrada">Entrada</option>
                <option value="salida">Salida</option>
              </select>
              <div class="hmv-muted" style="font-size:12px; margin-top:6px;">Entrada suma, salida resta.</div>
            </div>

            <div style="flex: 1 1 320px; min-width:260px;">
              <label style="display:block;font-weight:900;font-size:13px;margin-bottom:6px;">Modo de captura</label>

              <label class="hmv-checkbox" style="cursor:pointer;">
                <input type="checkbox" id="modo_cajas" onchange="toggleModo()"
                       {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}checked{% endif %}>
                <span>
                  Capturar en <b>{{ producto.unidad_compra or 'cajas/unidades' }}</b>
                  {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
                    <span class="hmv-muted" style="font-size:12px;">(convierte con {{ producto.piezas_por_unidad }} pzas)</span>
                  {% endif %}
                </span>
              </label>

              <div class="hmv-muted" style="font-size:12px; margin-top:6px;">
                {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
                  Si activas, capturas en {{ producto.unidad_compra or 'unid' }} y se convierte a piezas.
                {% else %}
                  Este producto no tiene “piezas por unidad”. Se recomienda capturar en piezas.
                {% endif %}
              </div>
            </div>
          </div>

          <div class="hmv-row" style="align-items:flex-end;">
            <!-- Cantidad en cajas -->
            <div id="grupo_cajas" style="flex: 1 1 220px; min-width:220px; display:none;">
              <label style="display:block;font-weight:900;font-size:13px;margin-bottom:6px;">
                Cantidad ({{ producto.unidad_compra or 'unid' }})
              </label>
              <input type="number" id="cantidad_cajas" min="1" value="1" oninput="calcularPiezas()"
                     style="width:100%;">
              <div class="hmv-muted" style="font-size:12px; margin-top:6px;">
                Ej. 1 {{ producto.unidad_compra or 'unid' }} = {{ producto.piezas_por_unidad or 0 }} pzas
              </div>
            </div>

            <!-- Cantidad en piezas (se envía al backend) -->
            <div id="grupo_piezas" style="flex: 1 1 220px; min-width:220px;">
              <label style="display:block;font-weight:900;font-size:13px;margin-bottom:6px;">
                Cantidad (piezas)
              </label>
              <input type="number" name="cantidad" id="cantidad_piezas" min="1" required
                     oninput="calcularDesdePiezas()"
                     style="width:100%;">
              <div class="hmv-muted" style="font-size:12px; margin-top:6px;">
                Si usas modo {{ producto.unidad_compra or 'cajas' }}, aquí se calcula automático.
              </div>
            </div>

            <!-- Nota -->
            <div style="flex: 2 1 420px; min-width:260px;">
              <label style="display:block;font-weight:900;font-size:13px;margin-bottom:6px;">Nota (opcional)</label>
              <input type="text" name="nota"
                     placeholder="Ej: Cirugía, merma, ajuste, compra, devolución..."
                     style="width:100%;">
            </div>
          </div>

          <!-- PREVIEW PRO -->
          <div class="hmv-callout" style="margin-top:14px;">
            <div class="hmv-row" style="align-items:flex-start;">
              <div>
                <div style="font-weight:900;">Resumen</div>
                <div class="hmv-muted" style="font-size:12px; margin-top:4px;">Prevención de errores antes de guardar.</div>
              </div>

              <div style="text-align:right;">
                <span id="pill_tipo" class="badge-hmv hmv-badge-success">ENTRADA</span>
              </div>
            </div>

            <div style="margin-top:10px;">
              <span class="badge-hmv">Se registrarán</span>
              <span style="font-weight:900; margin-left:8px;" id="preview_registro">0</span>
              <span class="hmv-muted" style="font-size:12px;">pzas</span>

              {% if producto.piezas_por_unidad and producto.piezas_por_unidad > 0 %}
                <div class="hmv-muted" style="font-size:12px; margin-top:6px;" id="preview_equiv">
                  ≈ 0 {{ producto.unidad_compra or 'unid' }}
                </div>
              {% else %}
                <div class="hmv-muted" style="font-size:12px; margin-top:6px;">
                  Este producto no tiene conversión configurada (piezas por unidad).
                </div>
              {% endif %}
            </div>

            <div class="hmv-divider"></div>

            <div class="hmv-row" style="align-items:center;">
              <div>
                <span class="hmv-muted" style="font-size:12px;">Stock después del movimiento:</span>
                <span style="font-weight:900; margin-left:6px;" id="preview_stock">{{ stock_pzas }}</span>
                <span class="hmv-muted" style="font-size:12px;">pzas</span>
              </div>

              <div id="alerta" style="display:none;">
                <span class="badge-hmv hmv-badge-danger">ALERTA</span>
                <span class="hmv-muted" style="font-size:12px; margin-left:6px;">
                  La salida deja el stock negativo. Revisa cantidad.
                </span>
              </div>
            </div>
          </div>

          <!-- Acciones abajo -->
          <div class="hmv-actions" style="margin-top:14px;">
            <button type="submit" class="hmv-btn-primary">Guardar movimiento</button>
            <a href="{{ url_for('movimientos', producto_id=producto.id) }}" class="hmv-btn-outline">Cancelar</a>
          </div>
        </div>
      </form>

    </div>
  </section>

{% endblock %}

{% block scripts %}
<script>
  const PPU = parseInt("{{ producto.piezas_por_unidad or 0 }}", 10) || 0;
  const STOCK = parseInt("{{ stock_pzas }}", 10) || 0;

  function onTipoChange(){
    actualizarPill();
    actualizarPreview();
  }

  function actualizarPill(){
    const tipo = document.getElementById("tipo").value;
    const pill = document.getElementById("pill_tipo");

    if (tipo === "salida"){
      pill.className = "badge-hmv hmv-badge-danger";
      pill.textContent = "SALIDA";
    } else {
      pill.className = "badge-hmv hmv-badge-success";
      pill.textContent = "ENTRADA";
    }
  }

  function toggleModo(){
    const modo = document.getElementById("modo_cajas").checked;
    const grupoCajas = document.getElementById("grupo_cajas");
    const piezasEl = document.getElementById("cantidad_piezas");

    if (modo && PPU > 0){
      grupoCajas.style.display = "block";
      piezasEl.readOnly = true;
      calcularPiezas();
    } else {
      grupoCajas.style.display = "none";
      piezasEl.readOnly = false;
      actualizarPreview();
    }
  }

  function calcularPiezas(){
    const cajas = parseInt(document.getElementById("cantidad_cajas").value || "0", 10);
    const piezas = (PPU > 0) ? (cajas * PPU) : cajas;

    document.getElementById("cantidad_piezas").value = piezas > 0 ? piezas : "";
    actualizarPreview();
  }

  function calcularDesdePiezas(){
    actualizarPreview();
  }

  function actualizarPreview(){
    const piezas = parseInt(document.getElementById("cantidad_piezas").value || "0", 10) || 0;
    document.getElementById("preview_registro").textContent = piezas;

    // equivalencia
    const equivEl = document.getElementById("preview_equiv");
    if (equivEl && PPU > 0){
      const equiv = Math.floor(piezas / PPU);
      equivEl.textContent = "≈ " + equiv + " {{ producto.unidad_compra or 'unid' }}";
    }

    // stock resultante
    const tipo = document.getElementById("tipo").value;
    const stockFinal = (tipo === "salida") ? (STOCK - piezas) : (STOCK + piezas);
    document.getElementById("preview_stock").textContent = stockFinal;

    // alerta si salida negativa
    const alerta = document.getElementById("alerta");
    if (tipo === "salida" && piezas > 0 && stockFinal < 0){
      alerta.style.display = "block";
    } else {
      alerta.style.display = "none";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    // Default cantidad 1
    const piezasEl = document.getElementById("cantidad_piezas");
    if (!piezasEl.value) piezasEl.value = 1;

    // Si no hay PPU, fuerza modo piezas
    if (PPU <= 0){
      document.getElementById("modo_cajas").checked = false;
    }

    actualizarPill();
    toggleModo();
    actualizarPreview();
  });
</script>
{% endblock %}
